#!/usr/bin/env bash
SOURCE_DIR="$HOME/dev/noctalia-shell/"
DEST_DIR="$HOME/.config/quickshell/noctalia-shell"
BACKUP_ROOT="$DEST_DIR/backup"

function usage() {
    echo "Usage: $0 [-r <timestamp>]"
    echo "  -r <timestamp>  Restore backup from specified timestamp (format: MMDDYYYYHHMM)"
    echo "  (no args)       Create backup and deploy latest version"
}

MODE="deploy"
RESTORE_TIMESTAMP=""

while getopts "r:h" opt; do
    case $opt in
        r)
            MODE="restore"
            RESTORE_TIMESTAMP="$OPTARG"
            ;;
        h)
            usage
            exit 0
            ;;
        *)
            usage
            exit 1
            ;;
    esac
done

if [ "$MODE" == "deploy" ]; then
    TIMESTAMP=$(date +"%m%d%Y%H%M")
    BACKUP_DIR="$BACKUP_ROOT/$TIMESTAMP"
    
    echo "Starting deployment..."
    
    # 1. Create Backup
    if [ -d "$DEST_DIR" ]; then
        echo "Creating backup at $BACKUP_DIR..."
        mkdir -p "$BACKUP_DIR"
        rsync -av \
            --exclude 'backup' \
            "$DEST_DIR/" "$BACKUP_DIR/"
    else
        echo "Destination directory does not exist, skipping backup."
        mkdir -p "$DEST_DIR"
    fi

    # 2. Deploy Files
    echo "Deploying new version..."
    rsync -av \
        --exclude '.git' \
        --exclude 'noctalia-shell.code-workspace' \
        --exclude '.gitignore' \
        "$SOURCE_DIR" "$DEST_DIR"

    # 3. Add to chezmoi
    echo "Adding to chezmoi..."
    chezmoi add "$DEST_DIR"
    
    echo "Deployment complete!"

elif [ "$MODE" == "restore" ]; then
    RESTORE_SOURCE="$BACKUP_ROOT/$RESTORE_TIMESTAMP"
    
    if [ -z "$RESTORE_TIMESTAMP" ]; then
        echo "Error: Timestamp required for restore."
        usage
        exit 1
    fi
    
    if [ ! -d "$RESTORE_SOURCE" ]; then
        echo "Error: Backup not found at $RESTORE_SOURCE"
        exit 1
    fi

    echo "Restoring backup from $RESTORE_TIMESTAMP..."
    
    # Restore using rsync --delete to mirror backup state
    # EXTREMELY IMPORTANT: --exclude 'backup' prevents deleting the backup repository itself
    rsync -av --delete \
        --exclude 'backup' \
        "$RESTORE_SOURCE/" "$DEST_DIR/"
        
    echo "Restore complete!"
fi
